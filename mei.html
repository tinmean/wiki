<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>老K梅花易數 - 專業卜卦系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;700&family=Inter:wght@400;600&display=swap');
        
        :root {
            --bg-warm: #FAF9F6;
            --card-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.04), 0 8px 10px -6px rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: 'Inter', 'Noto Serif TC', serif;
            background-color: var(--bg-warm);
            color: #332B25;
            -webkit-font-smoothing: antialiased;
        }

        .serif { font-family: 'Noto Serif TC', serif; }

        .trigram-line {
            height: 14px;
            margin: 8px 0;
            border-radius: 6px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-sizing: border-box;
        }

        /* 陽爻動爻標註 */
        .moving-line:not(.yin-line) { 
            background-color: #EF4444 !important; 
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            border: 2px solid #B91C1C !important;
            transform: scaleX(1.05);
            z-index: 20;
        }

        /* 陰爻樣式 */
        .yin-line { display: flex; justify-content: space-between; width: 100%; border: none !important; background: transparent !important; }
        .yin-line-part { 
            width: 45%; 
            height: 100%; 
            border-radius: 6px; 
            box-sizing: border-box;
            transition: all 0.4s ease;
        }

        /* 陰爻動爻標註 */
        .moving-line.yin-line .yin-line-part {
            background-color: #EF4444 !important;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            border: 2px solid #B91C1C !important;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: var(--card-shadow);
        }

        .history-item {
            transition: all 0.2s ease;
        }
        .history-item:hover {
            transform: translateY(-2px);
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .btn-primary {
            background: linear-gradient(135deg, #451A03 0%, #78350F 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(69, 26, 3, 0.3);
        }

        .pillar-box {
            background: #2D241E;
            color: #F5F5F4;
            transition: all 0.3s ease;
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #E7E5E4; border-radius: 10px; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease forwards; }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8 md:py-12">
        <!-- Header -->
        <header class="text-center mb-12 animate-fade-in">
            <h1 class="text-4xl md:text-5xl font-bold text-stone-900 serif tracking-tight mb-3">老K梅花易數</h1>
            <div class="flex items-center justify-center space-x-2 text-stone-500">
                <span class="h-px w-8 bg-stone-200"></span>
                <p class="text-sm font-medium italic serif">你被人K，來找老K</p>
                <span class="h-px w-8 bg-stone-200"></span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left Config Panel -->
            <div class="lg:col-span-4 space-y-6">
                <section class="glass-card p-6 rounded-3xl border border-stone-200">
                    <div class="flex items-center space-x-2 mb-6">
                        <i data-lucide="sparkles" class="w-5 h-5 text-amber-600"></i>
                        <h2 class="font-bold text-stone-800 text-lg serif">起卦設定</h2>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-[11px] font-bold text-stone-400 uppercase tracking-widest mb-2">起卦時間 (國曆)</label>
                            <input type="datetime-local" id="calcTime" class="w-full p-3 bg-stone-50 border border-stone-100 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-amber-500/20 transition">
                        </div>

                        <div class="grid grid-cols-3 gap-3">
                            <div class="space-y-2">
                                <label class="block text-center text-[10px] font-bold text-stone-400 uppercase">數一 (上)</label>
                                <input type="number" id="num1" placeholder="數" class="w-full p-3 bg-stone-50 border border-stone-100 rounded-xl text-sm text-center">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-center text-[10px] font-bold text-stone-400 uppercase">數二 (下)</label>
                                <input type="number" id="num2" placeholder="數" class="w-full p-3 bg-stone-50 border border-stone-100 rounded-xl text-sm text-center">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-center text-[10px] font-bold text-stone-400 uppercase">數三 (動)</label>
                                <input type="number" id="num3" placeholder="數" class="w-full p-3 bg-stone-50 border border-stone-100 rounded-xl text-sm text-center">
                            </div>
                        </div>

                        <div class="flex flex-col gap-3">
                            <button onclick="generateRandomNums()" class="w-full bg-stone-100 text-stone-700 py-3 rounded-xl text-sm font-semibold hover:bg-stone-200 transition flex items-center justify-center space-x-2">
                                <i data-lucide="dice-5" class="w-4 h-4"></i>
                                <span>隨機三數</span>
                            </button>
                            <button onclick="startDivination()" class="btn-primary w-full text-white py-4 rounded-xl text-sm font-bold shadow-lg flex items-center justify-center space-x-2">
                                <i data-lucide="layout-grid" class="w-4 h-4"></i>
                                <span>執行卜卦</span>
                            </button>
                        </div>
                    </div>
                </section>

                <section class="glass-card p-6 rounded-3xl border border-stone-200 overflow-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="history" class="w-5 h-5 text-stone-400"></i>
                            <h2 class="font-bold text-stone-800 serif">歷史紀錄</h2>
                        </div>
                        <button onclick="clearAllHistory()" class="text-xs text-stone-400 hover:text-red-500 transition font-medium">清除</button>
                    </div>
                    <div id="historyList" class="custom-scroll max-h-[400px] overflow-y-auto space-y-3 pr-1"></div>
                    <div class="mt-6 flex gap-2">
                        <button onclick="copyLatest()" class="flex-1 text-[11px] bg-white border border-stone-100 py-2.5 rounded-lg hover:bg-stone-50 transition font-bold text-stone-600 text-center">複製最新</button>
                        <button onclick="copyAllHistory()" class="flex-1 text-[11px] bg-white border border-stone-100 py-2.5 rounded-lg hover:bg-stone-50 transition font-bold text-stone-600 text-center">複製全部</button>
                    </div>
                </section>
            </div>

            <!-- Right Main Display Panel -->
            <div class="lg:col-span-8 space-y-6">
                <div id="resultArea" class="hidden space-y-8">
                    <!-- Ganzhi Pillars -->
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div class="pillar-box p-5 rounded-2xl shadow-lg border border-white/5 text-center">
                            <span class="block text-[10px] text-stone-500 font-bold uppercase tracking-widest mb-1">年柱</span>
                            <span id="resGzYear" class="text-2xl font-bold tracking-widest serif">--</span>
                        </div>
                        <div class="pillar-box p-5 rounded-2xl shadow-lg border border-white/5 text-center ring-2 ring-amber-500/30">
                            <span class="block text-[10px] text-stone-500 font-bold uppercase tracking-widest mb-1 text-amber-500/80">月柱</span>
                            <span id="resGzMonth" class="text-2xl font-bold tracking-widest text-amber-400 serif">--</span>
                        </div>
                        <div class="pillar-box p-5 rounded-2xl shadow-lg border border-white/5 text-center">
                            <span class="block text-[10px] text-stone-500 font-bold uppercase tracking-widest mb-1">日柱</span>
                            <span id="resGzDay" class="text-2xl font-bold tracking-widest text-emerald-400 serif">--</span>
                        </div>
                        <div class="pillar-box p-5 rounded-2xl shadow-lg border border-white/5 text-center">
                            <span class="block text-[10px] text-stone-500 font-bold uppercase tracking-widest mb-1">時柱</span>
                            <span id="resGzHour" class="text-2xl font-bold tracking-widest serif">--</span>
                        </div>
                    </div>

                    <!-- Meta Data -->
                    <div class="bg-white/60 backdrop-blur px-8 py-5 rounded-2xl border border-stone-200 flex flex-wrap justify-between items-center gap-4 shadow-sm">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center text-amber-600">
                                <i data-lucide="hash" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-stone-400 uppercase">起卦數字</p>
                                <span id="resNums" class="font-mono font-bold text-stone-800 text-lg"></span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center text-red-600">
                                <i data-lucide="zap" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-stone-400 uppercase">動爻位置</p>
                                <span id="resMoving" class="font-bold text-red-600 text-lg serif"></span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="glass-card p-8 rounded-[2.5rem] flex flex-col items-center border border-stone-100">
                            <p class="text-xs font-bold text-stone-400 uppercase tracking-widest mb-8 border-b border-stone-100 w-full pb-3 text-center">本卦 (主)</p>
                            <div id="hexOrig" class="flex flex-col-reverse items-center space-y-reverse w-40"></div>
                            <h3 id="nameOrig" class="mt-10 font-bold text-3xl text-stone-800 serif tracking-tighter text-center">--</h3>
                        </div>
                        
                        <div class="glass-card p-8 rounded-[2.5rem] flex flex-col items-center border border-stone-100">
                            <p class="text-xs font-bold text-stone-400 uppercase tracking-widest mb-8 border-b border-stone-100 w-full pb-3 text-center">互卦 (中)</p>
                            <div id="hexMutu" class="flex flex-col-reverse items-center space-y-reverse w-40"></div>
                            <h3 id="nameMutu" class="mt-10 font-bold text-3xl text-stone-800 serif tracking-tighter text-center">--</h3>
                        </div>

                        <div class="glass-card p-8 rounded-[2.5rem] flex flex-col items-center border border-stone-100">
                            <p class="text-xs font-bold text-stone-400 uppercase tracking-widest mb-8 border-b border-stone-100 w-full pb-3 text-center">變卦 (末)</p>
                            <div id="hexTran" class="flex flex-col-reverse items-center space-y-reverse w-40"></div>
                            <h3 id="nameTran" class="mt-10 font-bold text-3xl text-stone-800 serif tracking-tighter text-center">--</h3>
                        </div>
                    </div>
                </div>

                <div id="placeholder" class="h-96 flex flex-col items-center justify-center text-stone-300 border-2 border-dashed border-stone-200 rounded-[2.5rem] bg-white/40">
                    <div class="w-24 h-24 rounded-full bg-stone-50 flex items-center justify-center mb-6">
                        <i data-lucide="wind" class="w-10 h-10 text-stone-200"></i>
                    </div>
                    <p class="text-xl font-bold serif text-stone-400">心誠則靈，請起卦</p>
                    <p class="text-xs mt-2 font-medium opacity-60">輸入三組數字以顯現天機</p>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-stone-900 text-white px-6 py-3 rounded-2xl text-sm font-medium shadow-2xl transition-all duration-300 translate-y-24 opacity-0 z-50 flex items-center space-x-2">
        <i data-lucide="check-circle-2" class="w-4 h-4 text-emerald-400"></i>
        <span id="toastMsg">已複製</span>
    </div>

    <script>
        const STEMS = "甲乙丙丁戊己庚辛壬癸";
        const BRANCHES = "子丑寅卯辰巳午未申酉戌亥";
        
        const ELEMENT_STYLES = {
            "金": { bg: "#FFFFFF", border: "#E5E7EB", isLight: true },
            "木": { bg: "#22C55E", border: "#16A34A", isLight: false },
            "水": { bg: "#000000", border: "#000000", isLight: false },
            "火": { bg: "#DC2626", border: "#991B1B", isLight: false },
            "土": { bg: "#78350F", border: "#451A03", isLight: false }
        };

        const TRIGRAMS = [
            { id: 1, name: "乾", element: "金", binary: [1, 1, 1] },
            { id: 2, name: "兌", element: "金", binary: [1, 1, 0] },
            { id: 3, name: "離", element: "火", binary: [1, 0, 1] },
            { id: 4, name: "震", element: "木", binary: [1, 0, 0] },
            { id: 5, name: "巽", element: "木", binary: [0, 1, 1] },
            { id: 6, name: "坎", element: "水", binary: [0, 1, 0] },
            { id: 7, name: "艮", element: "土", binary: [0, 0, 1] },
            { id: 8, name: "坤", element: "土", binary: [0, 0, 0] }
        ];

        const HEX_NAMES = {
            "11": "乾為天", "12": "天澤履", "13": "天火同人", "14": "天雷無妄", "15": "天風姤", "16": "天水訟", "17": "天山遁", "18": "天地否",
            "21": "澤天夬", "22": "兌為澤", "23": "澤火革", "24": "澤雷隨", "25": "澤風大過", "26": "澤水困", "27": "澤山咸", "28": "澤地萃",
            "31": "火天大有", "32": "火澤睽", "33": "離為火", "34": "火雷噬嗑", "35": "火風鼎", "36": "火水未濟", "37": "火山旅", "38": "火地晉",
            "41": "雷天大壯", "42": "雷澤歸妹", "43": "雷火豐", "44": "震為雷", "45": "雷風恆", "46": "雷水解", "47": "雷山小過", "48": "雷地豫",
            "51": "風天小畜", "52": "風澤中孚", "53": "風火家人", "54": "風雷益", "55": "巽為風", "56": "風水渙", "57": "風山漸", "58": "風地觀",
            "61": "水天需", "62": "水澤節", "63": "水火既濟", "64": "水雷屯", "65": "水風井", "66": "坎為水", "67": "水山蹇", "68": "水地比",
            "71": "山天大畜", "72": "山澤損", "73": "山火賁", "74": "山雷頤", "75": "山風蠱", "76": "山水蒙", "77": "艮為山", "78": "山地剝",
            "81": "地天泰", "82": "地澤臨", "83": "地火明夷", "84": "地雷復", "85": "地風升", "86": "地水師", "87": "地山謙", "88": "坤為地"
        };

        /**
         * 專業干支計算邏輯 (早晚子時修正)
         */
        function getGanzhiPillars(dateObj) {
            let date = new Date(dateObj.getTime());
            let hour = date.getHours();
            
            // 早晚子時概念：日柱切換點為午夜 00:00
            // 23:00 - 23:59 為晚子時，日柱仍算當天
            const y = date.getFullYear();
            const m = date.getMonth() + 1;
            const d = date.getDate();

            // 1. 年柱：以立春為界
            let effY = y;
            if (m < 2 || (m === 2 && d < 4)) effY--;
            const yIdx = (effY - 4) % 60;
            const yStemIdx = (yIdx % 10 + 10) % 10;
            const gzYear = STEMS[yStemIdx] + BRANCHES[(yIdx % 12 + 12) % 12];

            // 2. 月柱：精確節氣 (1/5小寒, 2/4立春...)
            const termDays = [5, 4, 5, 5, 5, 6, 7, 7, 7, 8, 7, 7];
            let solarMIdx = (d >= termDays[m-1]) ? m : m - 1;
            if (solarMIdx <= 0) solarMIdx = 12;

            let mOrder = (solarMIdx === 1) ? 12 : solarMIdx - 1;
            const mStartStem = (yStemIdx % 5) * 2 + 2; 
            let mOffset = (mOrder === 12) ? 11 : mOrder - 1;
            const mStemIdx = (mStartStem + mOffset) % 10;
            const mBranchIdx = (mOrder === 12) ? 1 : (mOrder + 1) % 12;
            const gzMonth = STEMS[mStemIdx] + BRANCHES[mBranchIdx];

            // 3. 日柱：基準點 2024-01-01 為 甲子 (0)
            const anchor = new Date(2024, 0, 1);
            const d1 = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const d2 = new Date(anchor.getFullYear(), anchor.getMonth(), anchor.getDate());
            const diffDays = Math.round((d1 - d2) / 86400000);
            const dIdx = (diffDays % 60 + 60) % 60;
            const dStemIdx = dIdx % 10;
            const gzDay = STEMS[dStemIdx] + BRANCHES[dIdx % 12];

            // 4. 時柱：五鼠遁
            // 若為晚子時 (23:00-00:00)，雖日柱不進位，但時干須按隔日推算
            let hourOrder = Math.floor((hour + 1) % 24 / 2); // Zi=0, Chou=1...
            let dayStemForHour = dStemIdx;
            if (hour >= 23) {
                dayStemForHour = (dStemIdx + 1) % 10;
            }
            
            const hStartStem = (dayStemForHour % 5) * 2;
            const hStemIdx = (hStartStem + hourOrder) % 10;
            const gzHour = STEMS[hStemIdx] + BRANCHES[hourOrder];

            return { year: gzYear, month: gzMonth, day: gzDay, hour: gzHour };
        }

        function generateRandomNums() {
            document.getElementById('num1').value = Math.floor(Math.random() * 999) + 1;
            document.getElementById('num2').value = Math.floor(Math.random() * 999) + 1;
            document.getElementById('num3').value = Math.floor(Math.random() * 999) + 1;
        }

        function renderHexLines(containerId, upperT, lowerT, movingIdx = -1) {
            const container = document.getElementById(containerId);
            container.innerHTML = "";
            const lines = [...lowerT.binary, ...upperT.binary];
            
            lines.forEach((isYang, i) => {
                const isMoving = (i + 1 === movingIdx);
                const trigram = (i < 3) ? lowerT : upperT;
                const style = ELEMENT_STYLES[trigram.element];
                
                const line = document.createElement('div');
                line.className = "trigram-line w-full " + (isMoving ? "moving-line " : "");
                
                if (isYang) {
                    if (!isMoving) {
                        line.style.backgroundColor = style.bg;
                        line.style.border = `1px solid ${style.border}`;
                        if (style.isLight) line.style.boxShadow = "inset 0 1px 3px rgba(0,0,0,0.06)";
                    }
                } else {
                    line.classList.add('yin-line');
                    const p1 = document.createElement('div');
                    const p2 = document.createElement('div');
                    p1.className = p2.className = "yin-line-part";
                    if (!isMoving) {
                        p1.style.backgroundColor = p2.style.backgroundColor = style.bg;
                        p1.style.border = p2.style.border = `1px solid ${style.border}`;
                    }
                    line.appendChild(p1);
                    line.appendChild(p2);
                }
                container.appendChild(line);
            });
        }

        function startDivination(manualData = null) {
            let n1, n2, n3, date;
            if (manualData) {
                n1 = manualData.nums[0]; n2 = manualData.nums[1]; n3 = manualData.nums[2];
                date = new Date(manualData.timestamp);
            } else {
                n1 = parseInt(document.getElementById('num1').value);
                n2 = parseInt(document.getElementById('num2').value);
                n3 = parseInt(document.getElementById('num3').value);
                const tStr = document.getElementById('calcTime').value;
                if (isNaN(n1) || isNaN(n2) || isNaN(n3)) { showToast("請填寫起卦數字", "alert"); return; }
                date = tStr ? new Date(tStr) : new Date();
            }

            const pillars = getGanzhiPillars(date);
            const uT = TRIGRAMS[n1 % 8 === 0 ? 7 : (n1 % 8) - 1];
            const lT = TRIGRAMS[n2 % 8 === 0 ? 7 : (n2 % 8) - 1];
            const mov = n3 % 6 === 0 ? 6 : n3 % 6;

            document.getElementById('placeholder').classList.add('hidden');
            const resArea = document.getElementById('resultArea');
            resArea.classList.remove('hidden');
            resArea.classList.add('animate-fade-in');

            document.getElementById('resGzYear').innerText = pillars.year;
            document.getElementById('resGzMonth').innerText = pillars.month;
            document.getElementById('resGzDay').innerText = pillars.day;
            document.getElementById('resGzHour').innerText = pillars.hour;
            document.getElementById('resNums').innerText = `${n1}, ${n2}, ${n3}`;
            document.getElementById('resMoving').innerText = `第 ${mov} 爻`;

            renderHexLines("hexOrig", uT, lT, mov);
            document.getElementById('nameOrig').innerText = HEX_NAMES[uT.id.toString() + lT.id.toString()] || "自定義";

            const allL = [...lT.binary, ...uT.binary];
            const findT = (b) => TRIGRAMS.find(t => t.binary.every((v, idx) => v === b[idx]));
            
            const mu = findT([allL[2], allL[3], allL[4]]), ml = findT([allL[1], allL[2], allL[3]]);
            renderHexLines("hexMutu", mu, ml);
            document.getElementById('nameMutu').innerText = HEX_NAMES[mu.id.toString() + ml.id.toString()] || "自定義";

            let tL = [...allL]; tL[mov-1] = tL[mov-1] === 1 ? 0 : 1;
            const tu = findT(tL.slice(3, 6)), tl = findT(tL.slice(0, 3));
            renderHexLines("hexTran", tu, tl);
            document.getElementById('nameTran').innerText = HEX_NAMES[tu.id.toString() + tl.id.toString()] || "自定義";

            if (!manualData) {
                saveToHistory({ timestamp: date.getTime(), displayTime: date.toLocaleString(), nums: [n1, n2, n3], pillars, hexName: document.getElementById('nameOrig').innerText });
            }
            lucide.createIcons();
        }

        function saveToHistory(record) {
            let h = JSON.parse(localStorage.getItem('meihua_pro_v3') || '[]');
            h.unshift(record); if (h.length > 50) h.pop();
            localStorage.setItem('meihua_pro_v3', JSON.stringify(h));
            renderHistory();
        }

        function renderHistory() {
            const h = JSON.parse(localStorage.getItem('meihua_pro_v3') || '[]');
            const list = document.getElementById('historyList');
            list.innerHTML = h.length ? "" : '<div class="text-center py-8 text-stone-300 italic">暫無數據</div>';
            h.forEach(item => {
                const div = document.createElement('div');
                div.className = "history-item p-4 border border-stone-100 rounded-2xl bg-stone-50/50 cursor-pointer mb-3 transition";
                div.onclick = () => startDivination(item);
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-stone-800 serif text-base">${item.hexName}</span>
                        <span class="text-[10px] text-stone-400 font-medium">${item.displayTime}</span>
                    </div>
                    <div class="text-[11px] text-stone-500 font-mono">
                        ${item.pillars.year} ${item.pillars.month} ${item.pillars.day} ${item.pillars.hour} | 數：${item.nums.join(',')}
                    </div>`;
                list.appendChild(div);
            });
        }

        function clearAllHistory() { if (confirm("確定清除所有紀錄？")) { localStorage.removeItem('meihua_pro_v3'); renderHistory(); } }
        
        function copyLatest() {
            const h = JSON.parse(localStorage.getItem('meihua_pro_v3') || '[]')[0];
            if (!h) return;
            const t = `【老K梅花易數】\n時間：${h.displayTime}\n干支：${h.pillars.year} ${h.pillars.month} ${h.pillars.day} ${h.pillars.hour}\n起卦數：${h.nums.join(', ')}\n主卦：${h.hexName}`;
            copyToClipboard(t);
        }

        function copyAllHistory() {
            const h = JSON.parse(localStorage.getItem('meihua_pro_v3') || '[]');
            const t = h.map(x => `${x.displayTime} | ${x.pillars.year}${x.pillars.month}${x.pillars.day}${x.pillars.hour} | ${x.hexName}`).join('\n');
            copyToClipboard(t);
        }

        function copyToClipboard(text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showToast("成功複製到剪貼簿", "success");
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            toast.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => { toast.classList.add('translate-y-24', 'opacity-0'); }, 3000);
        }

        function setNow() { 
            const now = new Date(); 
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('calcTime').value = now.toISOString().slice(0, 16); 
        }

        window.onload = () => { setNow(); renderHistory(); lucide.createIcons(); };
    </script>
</body>
</html>
